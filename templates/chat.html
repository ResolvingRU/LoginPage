{% extends "base.html" %}

{% block title %}–ß–∞—Ç - SaveVillage{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
        </div>

        <div class="users-list" id="usersList">
            {% for user in users %}
            <div class="user-item" data-user-id="{{ user.id }}">
                <div class="user-avatar">
                    <span class="status-indicator {% if user in online_users %}status-online{% else %}status-offline{% endif %}"
                          id="status-{{ user.id }}"></span>
                    {{ user.username[0].upper() }}
                </div>
                <div class="user-info">
                    <span class="user-name">{{ user.username }}</span>
                    <span class="user-role role-{{ user.role }}">{{ user.role }}</span>
                </div>
                {% if current_user.is_moderator() and user.id != current_user.id and not user.is_moderator() %}
                <div class="user-actions">
                    {% if user.is_muted %}
                    <button class="btn-icon btn-unmute" onclick="unmuteUser({{ user.id }})" title="–†–∞–∑–º—É—Ç–∏—Ç—å">
                        üîä
                    </button>
                    {% else %}
                    <button class="btn-icon btn-mute" onclick="openMuteModal({{ user.id }}, '{{ user.username }}')" title="–ó–∞–º—É—Ç–∏—Ç—å">
                        üîá
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
            {% for msg in messages %}
            <div class="message" data-message-id="{{ msg.id }}" data-user-id="{{ msg.user_id }}">
                <div class="message-avatar">{{ msg.author.username[0].upper() }}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">{{ msg.author.username }}</span>
                        <span class="message-role role-{{ msg.author.role }}">{{ msg.author.role }}</span>
                        <span class="message-time">{{ msg.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    <div class="message-text">{{ msg.text }}</div>
                </div>
                {% if msg.user_id == current_user.id or current_user.is_moderator() %}
                <button class="message-delete" onclick="deleteMessage({{ msg.id }})">üóëÔ∏è</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="chat-input-container">
            {% if current_user.is_muted %}
            <div class="muted-notice">
                <span>üîá –í—ã –∑–∞–º—É—á–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</span>
            </div>
            {% else %}
            <form id="messageForm" class="chat-input-form">
                <input type="text"
                       id="messageInput"
                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                       autocomplete="off"
                       maxlength="1000">
                <button type="submit" class="btn-send">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º—É—Ç–∞ -->
<div id="muteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–ó–∞–º—É—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button class="modal-close" onclick="closeMuteModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ –¥–ª—è <strong id="muteUsername"></strong>:</p>
            <div class="mute-options">
                <button class="btn btn-mute-option" onclick="muteUser('10m')">10 –º–∏–Ω—É—Ç</button>
                <button class="btn btn-mute-option" onclick="muteUser('1h')">1 —á–∞—Å</button>
                <button class="btn btn-mute-option" onclick="muteUser('forever')">–ù–∞–≤—Å–µ–≥–¥–∞</button>
            </div>
            <div class="custom-mute">
                <label>–°–≤–æ—ë –≤—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã):</label>
                <input type="number" id="customMuteMinutes" min="1" max="10080" placeholder="60">
                <button class="btn btn-primary" onclick="muteUserCustom()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}