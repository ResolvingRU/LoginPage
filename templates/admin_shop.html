{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ - SaveVillage{% endblock %}

{% block content %}
<div class="admin-shop-container">
    <div class="admin-shop-header">
        <h2>üõí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º</h2>
        <div class="header-actions">
            <a href="{{ url_for('admin') }}" class="btn btn-secondary">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="{{ url_for('chat') }}" class="btn btn-secondary">üí¨ –ß–∞—Ç</a>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="admin-section">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
        <form id="addProductForm" class="product-form">
            <div class="form-row">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="productStock" min="0" required>
                </div>
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="productDescription" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                <small>–ü–æ–∫–∞ –≤—Å—Ç–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É. –ü–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤.</small>
            </div>
            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class="admin-section">
        <h3>üì¶ –¢–æ–≤–∞—Ä—ã ({{ products|length }})</h3>
        <div class="products-table">
            {% if products %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>
                            {% if product.image_url %}
                            <img src="{{ product.image_url }}" class="product-thumb" alt="{{ product.name }}">
                            {% else %}
                            <div class="product-thumb-placeholder">üì¶</div>
                            {% endif %}
                        </td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.price }} ‚ÇΩ</td>
                        <td>
                            <span class="stock-badge {% if product.stock == 0 %}stock-out{% endif %}">
                                {{ product.stock }}
                            </span>
                        </td>
                        <td>{{ product.created_at.strftime('%d.%m.%Y') }}</td>
                        <td>
                            <button class="btn-icon" onclick="editProduct({{ product.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn-icon btn-danger" onclick="deleteProduct({{ product.id }}, '{{ product.name }}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-message">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
            {% endif %}
        </div>
    </div>

    <!-- –ó–∞–∫–∞–∑—ã -->
    <div class="admin-section">
        <h3>üìã –ó–∞–∫–∞–∑—ã ({{ orders|length }})</h3>
        <div class="orders-table">
            {% if orders %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.customer.username }}</td>
                        <td>{{ order.total_price|round(2) }} ‚ÇΩ</td>
                        <td>
                            <select class="status-select status-{{ order.status }}"
                                    onchange="updateOrderStatus({{ order.id }}, this.value)">
                                <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>‚è≥ –û–∂–∏–¥–∞–µ—Ç</option>
                                <option value="paid" {% if order.status == 'paid' %}selected{% endif %}>üí≥ –û–ø–ª–∞—á–µ–Ω</option>
                                <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>üöö –û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                                <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω</option>
                                <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>‚ùå –û—Ç–º–µ–Ω—ë–Ω</option>
                            </select>
                        </td>
                        <td class="contact-cell">
                            <div>{{ order.contact_info }}</div>
                            <small>{{ order.delivery_address[:50] }}...</small>
                        </td>
                        <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <button class="btn-icon" onclick="viewOrder({{ order.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-message">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
document.getElementById('addProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData();
    formData.append('name', document.getElementById('productName').value);
    formData.append('description', document.getElementById('productDescription').value);
    formData.append('price', document.getElementById('productPrice').value);
    formData.append('stock', document.getElementById('productStock').value);
    formData.append('image_url', document.getElementById('productImage').value);

    try {
        const response = await fetch('/admin/shop/product/create', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showFlash(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showFlash(data.message, 'error');
        }
    } catch (error) {
        showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
    }
});

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function deleteProduct(productId, productName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${productName}"?`)) return;

    try {
        const response = await fetch(`/admin/shop/product/${productId}/delete`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            showFlash(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showFlash(data.message, 'error');
        }
    } catch (error) {
        showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞', 'error');
    }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
async function updateOrderStatus(orderId, status) {
    try {
        const response = await fetch(`/admin/shop/order/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status })
        });

        const data = await response.json();

        if (data.success) {
            showFlash(data.message, 'success');
        } else {
            showFlash(data.message, 'error');
        }
    } catch (error) {
        showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
    }
}

function showFlash(message, type) {
    const flashContainer = document.querySelector('.flash-container') || createFlashContainer();
    const flash = document.createElement('div');
    flash.className = `flash flash-${type}`;
    flash.innerHTML = `
        ${message}
        <button class="flash-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    flashContainer.appendChild(flash);
    setTimeout(() => flash.remove(), 3000);
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-container';
    document.body.appendChild(container);
    return container;
}
</script>

<style>
.admin-shop-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.admin-shop-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.product-form {
    max-width: 800px;
}

.form-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
}

.product-thumb {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 8px;
}

.product-thumb-placeholder {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    font-size: 1.5rem;
}

.stock-badge {
    padding: 0.25rem 0.75rem;
    background: rgba(0, 255, 136, 0.2);
    color: var(--accent-success);
    border-radius: 12px;
    font-weight: 600;
}

.stock-out {
    background: rgba(255, 0, 85, 0.2);
    color: var(--accent-danger);
}

.status-select {
    padding: 0.5rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-size: 0.9rem;
    font-weight: 600;
}

.status-select.status-pending {
    background: rgba(255, 170, 0, 0.2);
    color: var(--accent-warning);
}

.status-select.status-paid {
    background: rgba(0, 217, 255, 0.2);
    color: var(--accent-primary);
}

.status-select.status-shipped {
    background: rgba(179, 0, 255, 0.2);
    color: var(--accent-secondary);
}

.status-select.status-completed {
    background: rgba(0, 255, 136, 0.2);
    color: var(--accent-success);
}

.status-select.status-cancelled {
    background: rgba(255, 0, 85, 0.2);
    color: var(--accent-danger);
}

.contact-cell {
    max-width: 200px;
}

.contact-cell div {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.contact-cell small {
    color: var(--text-muted);
    display: block;
}

.empty-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

@media (max-width: 1024px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}